<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sug'urta Xizmatlarini Baholash</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* DIZAYN (O'zgarmadi) */
        :root {
            --primary-color: #003366;
            --accent-color: #D4AF37;
            --bg-color: #f4f7f6;
            --container-bg: #ffffff;
            --text-color: #333333;
            --input-border: #dddddd;
            --input-bg: #ffffff;
            --option-bg: #f9f9f9;
        }

        [data-theme="dark"] {
            --primary-color: #66b2ff;
            --accent-color: #D4AF37;
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --input-border: #444444;
            --input-bg: #2d2d2d;
            --option-bg: #2d2d2d;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; color: var(--text-color); transition: 0.3s; }
        .container { max-width: 750px; background: var(--container-bg); padding: 40px; margin: 0 auto; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-top: 5px solid var(--accent-color); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px; }
        .lang-switch button { background: none; border: 1px solid var(--input-border); color: var(--text-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left:5px;}
        .lang-switch button.active { background: var(--accent-color); color: #000; }
        .theme-toggle { cursor: pointer; font-size: 20px; background: none; border: none; color: var(--text-color); }
        .header { text-align: center; margin-bottom: 30px; }
        .header img { max-width: 250px; margin-bottom: 10px; }
        h1 { color: var(--primary-color); font-size: 24px; margin-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--primary-color); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--text-color); }
        .radio-group, .checkbox-group { background: var(--option-bg); padding: 15px; border-radius: 6px; border: 1px solid var(--input-border); }
        .option-item { display: flex; align-items: start; margin-bottom: 10px; }
        .option-item input { margin-right: 10px; width: 18px; height: 18px; margin-top: 3px; cursor: pointer; }
        .option-item label { margin-bottom: 0; cursor: pointer; line-height: 1.4; font-weight: normal; color: var(--text-color); }

        .module-section { border: 1px dashed var(--accent-color); border-radius: 8px; padding: 20px; margin-top: 30px; display: none; background: rgba(212, 175, 55, 0.05); }
        .module-section.active { display: block; animation: fadeIn 0.5s; }
        .module-title { color: var(--primary-color); border-bottom: 1px solid var(--input-border); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; text-transform: uppercase; }
        
        .rating-scale { display: flex; justify-content: space-between; max-width: 350px; margin: 10px 0; }
        .rating-item { text-align: center; }
        .rating-item div { font-size: 0.8em; margin-top: 5px; opacity: 0.8; }

        button.submit-btn { width: 100%; background: var(--primary-color); color: white; padding: 15px; font-size: 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        button.submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .loading, .success-message, .error-message { display: none; text-align: center; margin-top: 20px; padding: 15px; border-radius: 8px; }
        .loading { color: var(--primary-color); font-weight: bold; }
        .success-message { color: green; background: rgba(0, 128, 0, 0.1); border: 1px solid green; }
        .error-message { color: red; background: rgba(255, 0, 0, 0.1); border: 1px solid red; }
        
        #dashboard { display: none; margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 30px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .stats-card { background: var(--option-bg); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--input-border); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: var(--primary-color); }
        .dashboard-footer { margin-top: 30px; text-align: center; font-size: 0.9em; color: #777; font-style: italic; border-top: 1px solid var(--input-border); padding-top: 15px; } 

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (min-width: 600px) { .chart-grid { grid-template-columns: 1fr 1fr; } }
        .retry-btn { margin-top:15px; padding:10px 20px; background: var(--accent-color); color:#000; border:none; border-radius:4px; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <button class="theme-toggle" id="themeToggle" title="Tun/Kun">‚òÄÔ∏è</button>
        <div class="lang-switch">
            <button onclick="setLanguage('uz')" id="btn-uz" class="active">O'Z</button>
            <button onclick="setLanguage('ru')" id="btn-ru">–†–£</button>
            <button onclick="setLanguage('en')" id="btn-en">EN</button>
        </div>
    </div>

    <div class="header">
        <img src="https://raw.githubusercontent.com/sunattagayev-cloud/Sug-urta-tashkilotlari-mijozlari-uchun-so-rovnoma/refs/heads/main/Logo_03.svg" alt="Logo">
        <h1 data-key="title">Sug'urta xizmatlarini baholash</h1>
        <p class="intro" data-key="intro">Sizning fikringiz bizning rivojlanishimiz uchun muhim.</p>
    </div>

    <form id="insuranceForm">
        <input type="hidden" name="IP" id="userIP">

        <!-- I. KIRISH VA PROFIL -->
        <h3 style="color: var(--text-color); border-bottom: 1px solid var(--input-border); padding-bottom: 5px;" data-key="sec_general">I. KIRISH VA PROFIL</h3>

        <div class="form-group">
            <label data-key="lbl_client_type">1.1. Siz sug'urta xizmatidan kim sifatida foydalanasiz?</label>
            <div class="radio-group" id="clientTypeFilter">
                <div class="option-item"><input type="radio" name="Mijoz_Tipi" value="Jismoniy shaxs" required onchange="toggleAgeField()"><label data-key="opt_person">Jismoniy shaxs (O'z nomimdan)</label></div>
                <div class="option-item"><input type="radio" name="Mijoz_Tipi" value="Yuridik shaxs" onchange="toggleAgeField()"><label data-key="opt_legal">Yuridik shaxs (Korxona nomidan)</label></div>
            </div>
        </div>

        <div class="form-group" id="ageField" style="display:none;">
            <label data-key="lbl_age">1.2. Yoshingiz?</label>
            <div class="radio-group">
                <div class="option-item"><input type="radio" name="Yosh" value="18-25"><label>18-25</label></div>
                <div class="option-item"><input type="radio" name="Yosh" value="26-35"><label>26-35</label></div>
                <div class="option-item"><input type="radio" name="Yosh" value="36-50"><label>36-50</label></div>
                <div class="option-item"><input type="radio" name="Yosh" value="50+"><label>50+</label></div>
            </div>
        </div>

        <div class="form-group">
            <label data-key="lbl_region">1.3. Asosiy hududingiz</label>
            <select name="Hudud" required id="regionSelect" style="margin-bottom: 10px;"><option value="" data-key="sel_region">Yuklanmoqda...</option></select>
            <select name="Tuman" required id="districtSelect"><option value="" data-key="sel_district">Avval hududni tanlang</option></select>
        </div>

        <div class="form-group">
            <label data-key="lbl_gender">1.4. Jinsingiz</label>
            <div class="radio-group" style="display: flex; gap: 20px;">
                <div class="option-item"><input type="radio" name="Jinsi" value="Erkak" required><label data-key="gender_male">Erkak</label></div>
                <div class="option-item"><input type="radio" name="Jinsi" value="Ayol"><label data-key="gender_female">Ayol</label></div>
            </div>
        </div>

        <div class="form-group">
            <label data-key="lbl_company">1.5. Qaysi sug'urta kompaniyasining mijozi hisoblanasiz?</label>
            <select name="Kompaniya" id="companySelect" required>
                <option value="" data-key="sel_company">Kompaniyani tanlang...</option>
            </select>
        </div>

        <div class="form-group">
            <label data-key="lbl_contact">Bog'lanish uchun (Ixtiyoriy)</label>
            <span class="sub-text" data-key="contact_hint">Muammolarni yechishda aloqa qilish imkoni bo'lishi uchun.</span>
            <input type="text" name="Telefon" placeholder="+998 90 123 45 67" style="margin-bottom: 10px;" data-ph="ph_phone">
            <input type="email" name="Email" placeholder="email@domain.com" data-ph="ph_email">
        </div>

        <div class="form-group">
            <label data-key="lbl_source">1.6. Sug'urta kompaniyasi haqida qayerdan xabar topdingiz?</label>
            <select name="Manba" required>
                <option value="" data-key="sel_default">-- Tanlang --</option>
                <option value="Tanishlar" data-key="src_friends">Tanishlar</option>
                <option value="Reklama" data-key="src_ads">Reklama</option>
                <option value="Telegram">Telegram</option>
                <option value="Instagram">Instagram</option>
                <option value="Facebook">Facebook</option>
                <option value="Youtube">Youtube</option>
                <option value="Google/Yandex">Google/Yandex</option>
                <option value="2GIS / Maps" data-key="src_map">2GIS / Maps</option>
                <option value="Eski mijoz" data-key="src_client">Eski mijoz</option>
                <option value="Tasodifan" data-key="src_random">Tasodifan</option>
                <option value="Boshqa" data-key="src_other">Boshqa</option>
            </select>
        </div>

        <!-- II. FILTRLASH -->
        <h3 style="color: var(--text-color); border-bottom: 1px solid var(--input-border); padding-bottom: 5px; margin-top: 30px;" data-key="sec_filter">II. FILTRLASH</h3>

        <div class="form-group">
            <label data-key="lbl_services">2.1. Qaysi xizmatlardan foydalandingiz?</label>
            <div class="checkbox-group">
                <div class="option-item"><input type="checkbox" name="Xizmatlar" value="Avto" onchange="toggleModules()"><label data-key="srv_avto">Avtosug'urta (Majburiy/KASKO)</label></div>
                <div class="option-item"><input type="checkbox" name="Xizmatlar" value="Sogliq" onchange="toggleModules()"><label data-key="srv_health">Sog'liqni sug'urtalash (DMS)</label></div>
                <div class="option-item"><input type="checkbox" name="Xizmatlar" value="Sayohat" onchange="toggleModules()"><label data-key="srv_travel">Sayohat sug'urtasi</label></div>
                <div class="option-item"><input type="checkbox" name="Xizmatlar" value="Mulk" onchange="toggleModules()"><label data-key="srv_property">Mulk sug'urtasi</label></div>
                <div class="option-item"><input type="checkbox" name="Xizmatlar" value="Boshqa" onchange="toggleModules()"><label data-key="srv_other">Boshqa</label></div>
            </div>
        </div>

        <div class="form-group">
            <label data-key="lbl_claim_check">2.2. Sug'urta muddati davomida sug'urta hodisasi yuz berdimi?</label>
            <div class="radio-group" style="background: rgba(255, 0, 0, 0.05); border: 1px solid #ffcccc;">
                <div class="option-item"><input type="radio" name="Hodisa" value="Ha" required onchange="toggleModules()"><label data-key="opt_yes_claim">üî¥ Ha (To'lov olishga murojaat qilganman)</label></div>
                <div class="option-item"><input type="radio" name="Hodisa" value="Yo'q" onchange="toggleModules()"><label data-key="opt_no_claim">‚ö™ Yo'q (Faqat servisni baholayman)</label></div>
            </div>
        </div>

        <!-- MODULES -->
        
        <!-- A: AUTO -->
        <div id="module_avto" class="module-section">
            <h3 class="module-title" data-key="mod_a_title">üöó A-MODUL: Avtosug'urta</h3>
            <div class="form-group"><label data-key="a1_q">A1. Sug‚Äôurta turi:</label><div class="radio-group"><div class="option-item"><input type="radio" name="A_Tur" value="Majburiy"><label data-key="a1_opt1">Majburiy</label></div><div class="option-item"><input type="radio" name="A_Tur" value="Ixtiyoriy"><label data-key="a1_opt2">Ixtiyoriy</label></div></div></div>
            <div class="form-group"><label data-key="a2_q">A2. Rasmiylashtirish jarayoni:</label><div class="radio-group"><div class="option-item"><input type="radio" name="A_Rasmiylashtirish" value="Onlayn"><label data-key="a2_opt1">Onlayn oldim, juda tez</label></div><div class="option-item"><input type="radio" name="A_Rasmiylashtirish" value="Agent"><label data-key="a2_opt2">Agent kelib rasmiylashtirdi</label></div><div class="option-item"><input type="radio" name="A_Rasmiylashtirish" value="Ofis"><label data-key="a2_opt3">Ofisga borishga majbur bo'ldim</label></div></div></div>
            <div class="form-group"><label data-key="a3_q">A3. Narxlar shaffofligi:</label><div class="radio-group"><div class="option-item"><input type="radio" name="A_Narx" value="Tushunarli"><label data-key="a3_opt1">Tushunarli va o'rtacha</label></div><div class="option-item"><input type="radio" name="A_Narx" value="Majburiy xizmat"><label data-key="a3_opt2">Qo'shimcha xizmatlar majburlab qo'shildi</label></div><div class="option-item"><input type="radio" name="A_Narx" value="Qimmat"><label data-key="a3_opt3">Qimmat</label></div></div></div>
            <div class="form-group"><label data-key="rating_a">AVTOSUG'URTA BAHOSI (1-5):</label><div class="rating-scale"><label class="rating-item"><input type="radio" name="A_Baho" value="1"><div>1</div></label><label class="rating-item"><input type="radio" name="A_Baho" value="2"><div>2</div></label><label class="rating-item"><input type="radio" name="A_Baho" value="3"><div>3</div></label><label class="rating-item"><input type="radio" name="A_Baho" value="4"><div>4</div></label><label class="rating-item"><input type="radio" name="A_Baho" value="5"><div>5</div></label></div></div>
        </div>

        <!-- B: HEALTH -->
        <div id="module_health" class="module-section">
            <h3 class="module-title" data-key="mod_b_title">üè• B-MODUL: Sog'liqni sug'urtalash</h3>
            <div class="form-group"><label data-key="b1_q">B1. Klinikalar tarmog'i yetarlimi?</label><div class="radio-group"><div class="option-item"><input type="radio" name="B_Tarmoq" value="Ha"><label data-key="b1_opt1">Ha, tanlov katta</label></div><div class="option-item"><input type="radio" name="B_Tarmoq" value="Yo'q"><label data-key="b1_opt2">Yo'q, faqat markazda</label></div></div></div>
            <div class="form-group"><label data-key="b2_q">B2. Tasdiqlash tezligi:</label><div class="radio-group"><div class="option-item"><input type="radio" name="B_Tezlik" value="Tez"><label data-key="b2_opt1">Tez (Bot/Call-center)</label></div><div class="option-item"><input type="radio" name="B_Tezlik" value="Uzoq"><label data-key="b2_opt2">Uzoq kutdim, qiyin</label></div></div></div>
            <div class="form-group"><label data-key="rating_b">TIBBIY SUG'URTA BAHOSI (1-5):</label><div class="rating-scale"><label class="rating-item"><input type="radio" name="B_Baho" value="1"><div>1</div></label><label class="rating-item"><input type="radio" name="B_Baho" value="2"><div>2</div></label><label class="rating-item"><input type="radio" name="B_Baho" value="3"><div>3</div></label><label class="rating-item"><input type="radio" name="B_Baho" value="4"><div>4</div></label><label class="rating-item"><input type="radio" name="B_Baho" value="5"><div>5</div></label></div></div>
        </div>

        <!-- C: TRAVEL / PROPERTY / OTHER -->
        <div id="module_travel" class="module-section">
            <h3 class="module-title" data-key="mod_c_title">‚úàÔ∏èüè† C-MODUL: Boshqa sug'urta xizmatlari</h3>
            <div class="form-group"><label data-key="c1_q">C1. Xarid qilish qulayligi:</label><div class="radio-group"><div class="option-item"><input type="radio" name="C_Qulaylik" value="Agent"><label data-key="c1_opt1">Agent ofisga/uyga kelib rasmiylashtirdi</label></div><div class="option-item"><input type="radio" name="C_Qulaylik" value="Onlayn"><label data-key="c1_opt2">Onlayn oldim (E-Polis)</label></div><div class="option-item"><input type="radio" name="C_Qulaylik" value="Ofis"><label data-key="c1_opt3">Ofis qidirib yurdim</label></div></div></div>
            <div class="form-group"><label data-key="c2_q">C2. Assistans xizmati (Agarda sayohat bo'lsa):</label><div class="radio-group"><div class="option-item"><input type="radio" name="C_Assistans" value="Ha"><label data-key="c2_opt1">Ha, tushuntirildi</label></div><div class="option-item"><input type="radio" name="C_Assistans" value="Yo'q"><label data-key="c2_opt2">Yo'q</label></div></div></div>
            <div class="form-group"><label data-key="rating_c">XIZMAT SIFATI BAHOSI (1-5):</label><div class="rating-scale"><label class="rating-item"><input type="radio" name="C_Baho" value="1"><div>1</div></label><label class="rating-item"><input type="radio" name="C_Baho" value="2"><div>2</div></label><label class="rating-item"><input type="radio" name="C_Baho" value="3"><div>3</div></label><label class="rating-item"><input type="radio" name="C_Baho" value="4"><div>4</div></label><label class="rating-item"><input type="radio" name="C_Baho" value="5"><div>5</div></label></div></div>
        </div>

        <!-- D: CLAIM (ENG MUHIMI - faqat Hodisa=Ha bo'lsa) -->
        <div id="module_claim" class="module-section" style="border-color: red; background: rgba(255,0,0,0.02);">
            <h3 class="module-title" data-key="mod_d_title" style="color: red;">‚ö†Ô∏è D-MODUL: To'lovlar va Zararni qoplash</h3>
            <div class="form-group"><label data-key="d1_q">D1. Xodimlarning reaksiyasi:</label><div class="radio-group"><div class="option-item"><input type="radio" name="D_Reaksiya" value="Yaxshi"><label data-key="d1_opt1">Tezda yordam berishdi</label></div><div class="option-item"><input type="radio" name="D_Reaksiya" value="Qiyin"><label data-key="d1_opt2">Bog'lanish qiyin bo'ldi</label></div><div class="option-item"><input type="radio" name="D_Reaksiya" value="Yomon"><label data-key="d1_opt3">Qo'pol muomala qilishdi</label></div></div></div>
            <div class="form-group"><label data-key="d2_q">D2. Zararni baholash:</label><div class="radio-group"><div class="option-item"><input type="radio" name="D_Baholash" value="Haqiqiy"><label data-key="d2_opt1">Haqiqiy bozor narxida</label></div><div class="option-item"><input type="radio" name="D_Baholash" value="Kamaytirilgan"><label data-key="d2_opt2">Kamaytirib ko'rsatildi</label></div><div class="option-item"><input type="radio" name="D_Baholash" value="Cho'zilgan"><label data-key="d2_opt3">Juda cho'zilib ketdi</label></div></div></div>
            <div class="form-group"><label data-key="d3_q">D3. To'lab berish muddati:</label><div class="radio-group"><div class="option-item"><input type="radio" name="D_Muddat" value="Vaqtida"><label data-key="d3_opt1">Va'da qilingan vaqtda</label></div><div class="option-item"><input type="radio" name="D_Muddat" value="Kechikib"><label data-key="d3_opt2">Kechikib to'landi</label></div><div class="option-item"><input type="radio" name="D_Muddat" value="Rad etildi"><label data-key="d3_opt3">To'lashdan bosh tortishdi</label></div></div></div>
            <div class="form-group"><label data-key="rating_d">TO'LOV JARAYONI BAHOSI (1-5):</label><div class="rating-scale"><label class="rating-item"><input type="radio" name="D_Baho" value="1"><div>1</div></label><label class="rating-item"><input type="radio" name="D_Baho" value="2"><div>2</div></label><label class="rating-item"><input type="radio" name="D_Baho" value="3"><div>3</div></label><label class="rating-item"><input type="radio" name="D_Baho" value="4"><div>4</div></label><label class="rating-item"><input type="radio" name="D_Baho" value="5"><div>5</div></label></div></div>
        </div>

        <!-- E: DIGITAL (Doimiy) -->
        <div id="module_digital" class="module-section" style="display: block;">
            <h3 class="module-title" data-key="mod_e_title">üì± E-MODUL: Raqamli Xizmatlar</h3>
            <div class="form-group"><label data-key="e1_q">E1. E-Polis sotib olish imkoniyati:</label><div class="radio-group"><div class="option-item"><input type="radio" name="E_Epolis" value="Qulay"><label data-key="e1_opt1">Sayt/Ilova qulay</label></div><div class="option-item"><input type="radio" name="E_Epolis" value="Xatolik"><label data-key="e1_opt2">Xatoliklar ko'p</label></div></div></div>
            <div class="form-group"><label data-key="e2_q">E2. Onlayn qo'llab-quvvatlash:</label><div class="radio-group"><div class="option-item"><input type="radio" name="E_Support" value="Yaxshi"><label data-key="e2_opt1">Operatorlar malakali</label></div><div class="option-item"><input type="radio" name="E_Support" value="Yomon"><label data-key="e2_opt2">Javob olish qiyin</label></div></div></div>
            <div class="form-group"><label data-key="rating_e">IT XIZMATLAR BAHOSI (1-5):</label><div class="rating-scale"><label class="rating-item"><input type="radio" name="E_Baho" value="1"><div>1</div></label><label class="rating-item"><input type="radio" name="E_Baho" value="2"><div>2</div></label><label class="rating-item"><input type="radio" name="E_Baho" value="3"><div>3</div></label><label class="rating-item"><input type="radio" name="E_Baho" value="4"><div>4</div></label><label class="rating-item"><input type="radio" name="E_Baho" value="5"><div>5</div></label></div></div>
        </div>

        <button type="submit" id="submitBtn" class="submit-btn" data-key="btn_submit">Yuborish</button>
        <div class="loading" id="loading" data-key="msg_sending">Yuborilmoqda, kuting...</div>
        <div class="error-message" id="errorMessage" data-key="msg_error">Xatolik! Internetni tekshiring.</div>
    </form>
    
    <div class="success-message" id="successMessage">
        <h2 data-key="msg_thanks">Rahmat!</h2>
        <p data-key="msg_saved">Javobingiz qabul qilindi.</p>
        
        <div id="dashboard">
            <h3 data-key="dash_title" style="text-align:center; color:var(--primary-color);">üìä Umumiy Statistika (Live)</h3>
            <div class="chart-grid">
                <div class="stats-card">
                    <div class="stat-number" id="totalCount">...</div>
                    <div style="font-size:0.9em; opacity:0.8;" data-key="dash_total">Jami ishtirokchilar</div>
                </div>
                <div class="stats-card">
                    <div class="stat-number" id="claimCount">...</div>
                    <div style="font-size:0.9em; opacity:0.8;" data-key="dash_claims">To'lovga murojaat qilganlar</div>
                </div>
            </div>
            <div class="dashboard-footer" data-key="msg_footer">To'liq tahlil har oy yakunida e'lon qilinadi.</div>
        </div>

        <button onclick="location.reload()" class="retry-btn" data-key="btn_again" style="margin-top: 30px;">Yana yuborish</button>
    </div>
</div>

<script>
    // URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyh7lc11R46gFoXlG5mIy324f8EHvS5Y7ioq1xHeBLIHa2cVXKhZuuGFi9I5_iYAlhV/exec';
    
    // JSON Hududlar
    const regionsJsonUrl = "https://raw.githubusercontent.com/sunattagayev-cloud/Sug-urta-tashkilotlari-mijozlari-uchun-so-rovnoma/refs/heads/main/hududlar_va_tumanlar.json";
    
    // Sug'urta ro'yxati (Alifbo tartibida)
    const insuranceList = [
        "ALFA INVEST SUG`URTA KOMPANIYASI",
        "ALFA LIFE INSURANCE",
        "ALSKOM SUG`URTA KOMPANIYASI",
        "APEX INSURANCE",
        "APEX LIFE INSURANCE",
        "ARIA SUG`URTA TASHKILOTI",
        "ASIA INSURANCE SUG`URTA KOMPANIYASI",
        "EUROASIA INSURANCE",
        "GLOBAL INSURANCE GROUP",
        "GROSS SUG`URTA KOMPANIYASI",
        "HAMKOR SUG`URTA",
        "IMKON-SUG`URTA",
        "IMPEX-INSURANCE",
        "INFINITY INSURANCE",
        "INGO-UZBEKISTON SUG`URTA",
        "INSON",
        "ISHONCH SUG`URTA KOMPANIYASI",
        "KAFIL-SUG`URTA",
        "KAFOLAT HAYOT INSURANCE",
        "KAFOLAT SUG`URTA KOMPANIYASI",
        "KAPITAL SUG`URTA",
        "MOSAIC INSURANCE GROUP",
        "MY-INSURANCE",
        "NEO INSURANCE CORP",
        "O`ZAGROSUG`URTA",
        "O`ZBEKINVEST",
        "O`ZBEKINVEST HAYOT SUG`URTA KOMPANIYASI",
        "SEMURG INSURANCE",
        "SQB INSURANCE SUG`URTA KOMPANIYASI",
        "TBC SUG'URTA",
        "TEMIRYO`L SUG`URTA",
        "TRUST-INSURANCE",
        "XALQ SUG`URTA"
    ];

    let currentLang = 'uz';
    const adminIP = "94.158.58.35";
    let currentUserIP = "";
    let regionsData = [];

    const translations = {
        uz: {
            title: "Sug'urta xizmatlarini baholash", intro: "Xizmat sifatini yaxshilashda o'z hissangizni qo'shing.",
            sec_general: "I. KIRISH VA PROFIL",
            lbl_client_type: "1.1. Siz sug'urta xizmatidan kim sifatida foydalanasiz?", opt_person: "Jismoniy shaxs", opt_legal: "Yuridik shaxs (Korxona)",
            lbl_company: "1.5. Qaysi sug'urta kompaniyasining mijozi hisoblanasiz?", sel_company: "Kompaniyani tanlang...",
            lbl_contact: "Aloqa ma'lumotlari (Ixtiyoriy)", contact_hint: "Muammolarni yechishda aloqa qilish imkoni bo'lishi uchun.", ph_phone: "Telefon raqam", ph_email: "Email manzil (agar bor bo'lsa)",
            lbl_age: "1.2. Yoshingiz?", lbl_gender: "1.4. Jinsingiz", gender_male: "Erkak", gender_female: "Ayol",
            lbl_region: "1.3. Hudud va Tuman",  sel_region: "Yuklanmoqda...", sel_district: "Avval hududni tanlang...",
            lbl_source: "1.6. Sug'urta kompaniyasi haqida qayerdan xabar topdingiz?", sel_default: "-- Tanlang --",
            src_friends: "Tanishlar", src_ads: "Reklama", src_map: "2GIS / Maps", src_client: "Eski mijoz", src_random: "Tasodifan", src_other: "Boshqa",

            sec_filter: "II. FILTRLASH",
            lbl_services: "2.1. Qaysi xizmatlardan foydalandingiz?",
            srv_avto: "Avtosug'urta (Majburiy/KASKO)", srv_health: "Sog'liqni sug'urtalash (DMS)", srv_travel: "Sayohat sug'urtasi", srv_property: "Mulk sug'urtasi", srv_other: "Boshqa",
            lbl_claim_check: "2.2. Sug'urta muddati davomida sug'urta hodisasi yuz berdimi?",
            opt_yes_claim: "üî¥ Ha (To'lov olishga murojaat qilganman)", opt_no_claim: "‚ö™ Yo'q (Faqat servisni baholayman)",
            
            // Modules
            mod_a_title: "üöó A-MODUL: Avtosug'urta", a1_q: "A1. Sug‚Äôurta turi:", a1_opt1: "Majburiy", a1_opt2: "Ixtiyoriy",
            a2_q: "A2. Rasmiylashtirish:", a2_opt1: "Onlayn (juda tez)", a2_opt2: "Agent orqali", a2_opt3: "Ofisga borganman",
            a3_q: "A3. Narxlar:", a3_opt1: "Tushunarli", a3_opt2: "Majburiy xizmat qo'shildi", a3_opt3: "Qimmat",
            rating_a: "AVTOSUG'URTA BAHOSI (1-5):",

            mod_b_title: "üè• B-MODUL: Tibbiy sug'urta", b1_q: "B1. Klinikalar yetarlimi?", b1_opt1: "Ha, ko'p", b1_opt2: "Yo'q, kam",
            b2_q: "B2. Tasdiqlash tezligi:", b2_opt1: "Tez", b2_opt2: "Uzoq",
            rating_b: "TIBBIY SUG'URTA BAHOSI (1-5):",

            mod_c_title: "‚úàÔ∏èüè† C-MODUL: Boshqa sug'urta xizmatlari", c1_q: "C1. Xarid qilish qulayligi:", c1_opt1: "Agent ofisga/uyga kelib rasmiylashtirdi", c1_opt2: "Onlayn oldim (E-Polis)", c1_opt3: "Ofis qidirib yurdim",
            c2_q: "C2. Assistans xizmati (Agarda sayohat bo'lsa):", c2_opt1: "Ha, tushuntirildi", c2_opt2: "Yo'q",
            rating_c: "XIZMAT SIFATI BAHOSI (1-5):",

            mod_d_title: "‚ö†Ô∏è D-MODUL: To'lovlar va Zararni qoplash", d1_q: "D1. Xodimlarning reaksiyasi:", d1_opt1: "Tez yordam berishdi", d1_opt2: "Bog'lanish qiyin", d1_opt3: "Qo'pol",
            d2_q: "D2. Zararni baholash:", d2_opt1: "Haqiqiy narxda", d2_opt2: "Kamaytirib ko'rsatildi", d2_opt3: "Cho'zilib ketdi",
            d3_q: "D3. To'lov muddati:", d3_opt1: "Vaqtida", d3_opt2: "Kechikib", d3_opt3: "Rad etildi",
            rating_d: "TO'LOV JARAYONI BAHOSI (1-5):",

            mod_e_title: "üì± E-MODUL: Raqamli Xizmatlar", e1_q: "E1. E-Polis tizimi:", e1_opt1: "Qulay", e1_opt2: "Xatolik ko'p",
            e2_q: "E2. Online Support:", e2_opt1: "Yaxshi", e2_opt2: "Yomon",
            rating_e: "IT XIZMATLAR BAHOSI (1-5):",

            btn_submit: "Yuborish", msg_sending: "Yuborilmoqda...", msg_error: "Xatolik!", msg_thanks: "Rahmat!", msg_saved: "Javob qabul qilindi.", btn_again: "Yana yuborish",
            alert_limit: "Siz bugun ushbu kompaniyaga ovoz bergansiz!", alert_service: "Kamida bitta xizmatni tanlang!",
            dash_title: "üìä Statistika", dash_total: "Jami", dash_claims: "To'lovga murojaat qilganlar", msg_footer: "Tahlil oy oxirida e'lon qilinadi."
        },
        ru: {
            title: "–û—Ü–µ–Ω–∫–∞ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö —É—Å–ª—É–≥", intro: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π.",
            sec_general: "I. –ü–†–û–§–ò–õ–¨",
            lbl_client_type: "1.1. –í–∞—à —Å—Ç–∞—Ç—É—Å:", opt_person: "–§–∏–∑. –ª–∏—Ü–æ", opt_legal: "–Æ—Ä. –ª–∏—Ü–æ",
            lbl_company: "1.5. –í–∞—à–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è?", sel_company: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é...",
            lbl_contact: "–ö–æ–Ω—Ç–∞–∫—Ç—ã (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", contact_hint: "–ß—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–º–æ—á—å –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º.", ph_phone: "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", ph_email: "Email (–µ—Å–ª–∏ –µ—Å—Ç—å)",
            lbl_age: "1.2. –í–∞—à –≤–æ–∑—Ä–∞—Å—Ç", lbl_gender: "1.4. –í–∞—à –ø–æ–ª", gender_male: "–ú—É–∂—Å–∫–æ–π", gender_female: "–ñ–µ–Ω—Å–∫–∏–π",
            lbl_region: "1.3. –†–µ–≥–∏–æ–Ω", sel_region: "–ó–∞–≥—Ä—É–∑–∫–∞...", sel_district: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω",
            lbl_source: "1.6. –û—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª–∏?", sel_default: "-- –í—ã–±–µ—Ä–∏—Ç–µ --", src_friends: "–ó–Ω–∞–∫–æ–º—ã–µ", src_ads: "–†–µ–∫–ª–∞–º–∞", src_map: "–ö–∞—Ä—Ç—ã", src_client: "–ö–ª–∏–µ–Ω—Ç", src_random: "–°–ª—É—á–∞–π–Ω–æ", src_other: "–î—Ä—É–≥–æ–µ",

            sec_filter: "II. –§–ò–õ–¨–¢–†",
            lbl_services: "2.1. –ö–∞–∫–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å?",
            srv_avto: "–ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ", srv_health: "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ (–î–ú–°)", srv_travel: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", srv_property: "–ò–º—É—â–µ—Å—Ç–≤–æ", srv_other: "–î—Ä—É–≥–æ–µ",
            lbl_claim_check: "2.2. –ë—ã–ª –ª–∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–π —Å–ª—É—á–∞–π?",
            opt_yes_claim: "üî¥ –î–∞ (–û–±—Ä–∞—â–∞–ª—Å—è –∑–∞ –≤—ã–ø–ª–∞—Ç–æ–π)", opt_no_claim: "‚ö™ –ù–µ—Ç (–û—Ü–µ–Ω–∏–≤–∞—é —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å)",
            
            mod_a_title: "üöó –ú–æ–¥—É–ª—å A: –ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ", a1_q: "A1. –¢–∏–ø:", a1_opt1: "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ", a1_opt2: "–î–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ–µ",
            a2_q: "A2. –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ:", a2_opt1: "–û–Ω–ª–∞–π–Ω", a2_opt2: "–ê–≥–µ–Ω—Ç", a2_opt3: "–û—Ñ–∏—Å",
            a3_q: "A3. –¶–µ–Ω—ã:", a3_opt1: "–ü–æ–Ω—è—Ç–Ω—ã–µ", a3_opt2: "–ù–∞–≤—è–∑–∞–ª–∏ —É—Å–ª—É–≥–∏", a3_opt3: "–î–æ—Ä–æ–≥–æ",
            rating_a: "–û–¶–ï–ù–ö–ê –ê–í–¢–û (1-5):",

            mod_b_title: "üè• –ú–æ–¥—É–ª—å B: –ú–µ–¥–∏—Ü–∏–Ω–∞", b1_q: "B1. –°–µ—Ç—å –∫–ª–∏–Ω–∏–∫?", b1_opt1: "–®–∏—Ä–æ–∫–∞—è", b1_opt2: "–ú–∞–ª–æ",
            b2_q: "B2. –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:", b2_opt1: "–ë—ã—Å—Ç—Ä–æ", b2_opt2: "–î–æ–ª–≥–æ",
            rating_b: "–û–¶–ï–ù–ö–ê –ú–ï–î (1-5):",

            mod_c_title: "‚úàÔ∏èüè† –ú–æ–¥—É–ª—å C: –î—Ä—É–≥–∏–µ –≤–∏–¥—ã —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è", c1_q: "C1. –ü–æ–∫—É–ø–∫–∞:", c1_opt1: "–ê–≥–µ–Ω—Ç –æ—Ñ–æ—Ä–º–∏–ª –Ω–∞ –º–µ—Å—Ç–µ", c1_opt2: "–û–Ω–ª–∞–π–Ω", c1_opt3: "–ò—Å–∫–∞–ª –æ—Ñ–∏—Å",
            c2_q: "C2. –ê—Å—Å–∏—Å—Ç–∞–Ω—Å (–¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π)?", c2_opt1: "–î–∞, –æ–±—ä—è—Å–Ω–∏–ª–∏", c2_opt2: "–ù–µ—Ç",
            rating_c: "–û–¶–ï–ù–ö–ê (1-5):",

            mod_d_title: "‚ö†Ô∏è –ú–æ–¥—É–ª—å D: –í—ã–ø–ª–∞—Ç—ã (–£—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)", d1_q: "D1. –†–µ–∞–∫—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:", d1_opt1: "–ü–æ–º–æ–≥–ª–∏ –±—ã—Å—Ç—Ä–æ", d1_opt2: "–°–ª–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è", d1_opt3: "–ì—Ä—É–±–æ",
            d2_q: "D2. –û—Ü–µ–Ω–∫–∞ —É—â–µ—Ä–±–∞:", d2_opt1: "–†—ã–Ω–æ—á–Ω–∞—è", d2_opt2: "–ó–∞–Ω–∏–∂–µ–Ω–Ω–∞—è", d2_opt3: "–ó–∞—Ç—è–Ω—É—Ç–æ",
            d3_q: "D3. –°—Ä–æ–∫–∏ –≤—ã–ø–ª–∞—Ç—ã:", d3_opt1: "–í–æ–≤—Ä–µ–º—è", d3_opt2: "–° –∑–∞–¥–µ—Ä–∂–∫–æ–π", d3_opt3: "–û—Ç–∫–∞–∑",
            rating_d: "–û–¶–ï–ù–ö–ê –í–´–ü–õ–ê–¢ (1-5):",

            mod_e_title: "üì± –ú–æ–¥—É–ª—å E: –¶–∏—Ñ—Ä–æ–≤—ã–µ —É—Å–ª—É–≥–∏", e1_q: "E1. –ï-–ü–æ–ª–∏—Å:", e1_opt1: "–£–¥–æ–±–Ω–æ", e1_opt2: "–û—à–∏–±–∫–∏",
            e2_q: "E2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞:", e2_opt1: "–•–æ—Ä–æ—à–æ", e2_opt2: "–ü–ª–æ—Ö–æ",
            rating_e: "IT –û–¶–ï–ù–ö–ê (1-5):",

            btn_submit: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", msg_sending: "–û—Ç–ø—Ä–∞–≤–∫–∞...", msg_error: "–û—à–∏–±–∫–∞!", msg_thanks: "–°–ø–∞—Å–∏–±–æ!", msg_saved: "–ü—Ä–∏–Ω—è—Ç–æ.", btn_again: "–ï—â–µ —Ä–∞–∑",
            alert_limit: "–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –∫–æ–º–ø–∞–Ω–∏—é!", alert_service: "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É!", dash_title: "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", dash_total: "–í—Å–µ–≥–æ", dash_claims: "–û–±—Ä–∞—Ç–∏–≤—à–∏–µ—Å—è –∑–∞ –≤—ã–ø–ª–∞—Ç–æ–π", msg_footer: "–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞."
        },
        en: {
            title: "Insurance Evaluation", intro: "Help us improve service.",
            sec_general: "I. PROFILE",
            lbl_client_type: "1.1. Client Type:", opt_person: "Individual", opt_legal: "Corporate",
            lbl_company: "1.5. Insurance Company:", sel_company: "Select...",
            lbl_contact: "Contact (Optional)", contact_hint: "To help solve your issues.", ph_phone: "Phone number", ph_email: "Email address",
            lbl_age: "1.2. Age", lbl_gender: "1.4. Gender", gender_male: "Male", gender_female: "Female",
            lbl_region: "1.3. Region", sel_region: "Loading...", sel_district: "Select District",
            lbl_source: "1.6. Source?", sel_default: "-- Select --", src_friends: "Friends", src_ads: "Ads", src_map: "Maps", src_client: "Client", src_random: "Random", src_other: "Other",

            sec_filter: "II. FILTER",
            lbl_services: "2.1. Services used?",
            srv_avto: "Auto Insurance", srv_health: "Health", srv_travel: "Travel", srv_property: "Property", srv_other: "Other",
            lbl_claim_check: "2.2. Did any insurance event occur?",
            opt_yes_claim: "üî¥ Yes (Applied for payout)", opt_no_claim: "‚ö™ No (Rating service only)",
            
            mod_a_title: "üöó Module A: Auto", a1_q: "A1. Type:", a1_opt1: "Mandatory", a1_opt2: "Voluntary",
            a2_q: "A2. Process:", a2_opt1: "Online", a2_opt2: "Agent", a2_opt3: "Office",
            a3_q: "A3. Price:", a3_opt1: "Fair", a3_opt2: "Forced addons", a3_opt3: "Expensive",
            rating_a: "RATING (1-5):",

            mod_b_title: "üè• Module B: Health", b1_q: "B1. Clinics network?", b1_opt1: "Wide", b1_opt2: "Limited",
            b2_q: "B2. Approval speed:", b2_opt1: "Fast", b2_opt2: "Slow",
            rating_b: "RATING (1-5):",

            mod_c_title: "‚úàÔ∏èüè† Module C: Other Services", c1_q: "C1. Purchase:", c1_opt1: "Agent visited", c1_opt2: "Online", c1_opt3: "Office",
            c2_q: "C2. Assistance info (Travel)?", c2_opt1: "Yes", c2_opt2: "No",
            rating_c: "RATING (1-5):",

            mod_d_title: "‚ö†Ô∏è Module D: Claims", d1_q: "D1. Staff reaction:", d1_opt1: "Helpful", d1_opt2: "Hard to reach", d1_opt3: "Rude",
            d2_q: "D2. Assessment:", d2_opt1: "Fair", d2_opt2: "Undervalued", d2_opt3: "Too long",
            d3_q: "D3. Payout time:", d3_opt1: "On time", d3_opt2: "Delayed", d3_opt3: "Denied",
            rating_d: "PAYOUT RATING (1-5):",

            mod_e_title: "üì± Module E: Digital", e1_q: "E1. E-Policy:", e1_opt1: "Convenient", e1_opt2: "Errors",
            e2_q: "E2. Support:", e2_opt1: "Good", e2_opt2: "Bad",
            rating_e: "IT RATING (1-5):",

            btn_submit: "Submit", msg_sending: "Sending...", msg_error: "Error!", msg_thanks: "Thanks!", msg_saved: "Saved.", btn_again: "Again",
            alert_limit: "You already voted today!", alert_service: "Select at least one service!", dash_title: "üìä Stats", dash_total: "Total", dash_claims: "Applied for payout", msg_footer: "Full analysis published at month end."
        }
    };

    window.addEventListener('DOMContentLoaded', () => {
        loadCompanies();
        setLanguage('uz');
        
        fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(d => { 
                document.getElementById('userIP').value = d.ip; 
                currentUserIP = d.ip;
            }).catch(e => console.log(e));

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').innerText = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    });

    async function  loadCompanies() {
        // Hududlarni ham yuklab olamiz
        try {
            const res = await fetch(regionsJsonUrl);
            regionsData = await res.json();
            populateRegions();
        } catch (error) { console.error(error); }

        const select = document.getElementById('companySelect');
        insuranceList.sort().forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            select.appendChild(opt);
        });
    }

    function populateRegions() {
        const regionSelect = document.getElementById('regionSelect');
        const t = translations[currentLang];
        if(!regionsData || regionsData.length === 0) return;
        
        // Save current selection
        const currentVal = regionSelect.value;
        regionSelect.innerHTML = `<option value="">${t.sel_region}</option>`;
        
        regionsData.forEach((region) => {
            const opt = document.createElement('option');
            const langKey = 'name_' + currentLang;
            const regionName = region[langKey] || region.name_uz;
            opt.value = region.name_uz; 
            opt.innerText = regionName;
            regionSelect.appendChild(opt);
        });
        regionSelect.value = currentVal;
    }

    // Tumanlarni yangilash
    document.getElementById('regionSelect').addEventListener('change', function() {
        const selRegion = this.value;
        const districtSelect = document.getElementById('districtSelect');
        const t = translations[currentLang];
        districtSelect.innerHTML = `<option value="">${t.sel_district}</option>`;

        const regionObj = regionsData.find(r => r.name_uz === selRegion);
        if (regionObj && regionObj.districts) {
            regionObj.districts.forEach(dist => {
                 const opt = document.createElement('option');
                 const langKey = 'name_' + currentLang;
                 const distName = dist[langKey] || dist.name_uz;
                 opt.value = dist.name_uz;
                 opt.innerText = distName;
                 districtSelect.appendChild(opt);
            });
        }
    });

    function setLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (t[key]) el.innerText = t[key];
        });
        document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+lang).classList.add('active');
        populateRegions();
    }

    // --- YOSHNI KO'RSATISH ---
    window.toggleAgeField = function() {
        const type = document.querySelector('input[name="Mijoz_Tipi"]:checked')?.value;
        const ageDiv = document.getElementById('ageField');
        if (type === 'Jismoniy shaxs') {
            ageDiv.style.display = 'block';
            ageDiv.querySelectorAll('input').forEach(i => i.required = true);
        } else {
            ageDiv.style.display = 'none';
            ageDiv.querySelectorAll('input').forEach(i => { i.required = false; i.checked = false; });
        }
    }

    // --- MANTIQ (TOGGLE) ---
    window.toggleModules = function() {
        // 1. Reset all modules
        const allMods = ['module_avto', 'module_health', 'module_travel', 'module_claim', 'module_digital'];
        allMods.forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('active');
            el.querySelectorAll('input, select').forEach(i => { i.disabled = true; i.required = false; });
        });

        // 2. Doimiy ochiq modul (E - Digital) - Bu barcha uchun
        const modE = document.getElementById('module_digital');
        modE.classList.add('active');
        modE.querySelectorAll('input').forEach(i => i.disabled = false);

        // 3. Xizmatlar (Checkbox)
        const services = Array.from(document.querySelectorAll('input[name="Xizmatlar"]:checked')).map(c => c.value);
        
        if (services.includes('Avto')) activateMod('module_avto');
        if (services.includes('Sogliq')) activateMod('module_health');
        // Sayohat, Mulk yoki Boshqa tanlansa -> C Modul ochiladi
        if (services.includes('Sayohat') || services.includes('Mulk') || services.includes('Boshqa')) activateMod('module_travel');

        // 4. Hodisa (Claim) - D Modul
        const claimVal = document.querySelector('input[name="Hodisa"]:checked')?.value;
        if (claimVal === 'Ha') {
            activateMod('module_claim');
        }
    }

    function activateMod(id) {
        const el = document.getElementById(id);
        el.classList.add('active');
        el.querySelectorAll('input, select').forEach(i => i.disabled = false);
        // Reyting majburiy
        const radios = el.querySelectorAll('.rating-scale input[type="radio"]');
        if(radios.length > 0) radios[0].required = true;
    }

    // FORMA YUBORISH
    document.getElementById('insuranceForm').addEventListener('submit', e => {
        e.preventDefault();
        const t = translations[currentLang];

        // IP Check
        const comp = document.getElementById('companySelect').value;
        if (currentUserIP !== adminIP) {
            let history = JSON.parse(localStorage.getItem('insHistory')) || {};
            if (history[comp] === new Date().toDateString()) {
                alert(t.alert_limit); return;
            }
        }

        const svcs = document.querySelectorAll('input[name="Xizmatlar"]:checked');
        if (svcs.length === 0) { alert(t.alert_service); return; }

        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        
        btn.disabled = true;
        btn.style.opacity = '0.5';
        loading.style.display = 'block';

        const formData = new FormData(e.target);
        // Checkbox array fix
        const xizmatArr = [];
        svcs.forEach(s => xizmatArr.push(s.value));
        formData.set('Xizmatlar', xizmatArr.join(', '));

        fetch(scriptURL, { method: 'POST', body: formData })
        .then(res => {
            if (currentUserIP !== adminIP) {
                let history = JSON.parse(localStorage.getItem('insHistory')) || {};
                history[comp] = new Date().toDateString();
                localStorage.setItem('insHistory', JSON.stringify(history));
            }
            loading.style.display = 'none';
            document.getElementById('insuranceForm').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
            loadDashboard();
        })
        .catch(err => {
            console.error(err);
            loading.style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    });

    function loadDashboard() {
        document.getElementById('dashboard').style.display = 'block';
        fetch(scriptURL)
            .then(r => r.json())
            .then(data => {
                if(data.total) document.getElementById('totalCount').innerText = data.total;
                if(data.claimCount !== undefined) document.getElementById('claimCount').innerText = data.claimCount;
            })
            .catch(e => console.log(e));
    }

    document.getElementById('themeToggle').addEventListener('click', () => {
        const body = document.body;
        const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', newTheme);
        document.getElementById('themeToggle').innerText = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', newTheme);
    });
</script>

</body>
</html>
